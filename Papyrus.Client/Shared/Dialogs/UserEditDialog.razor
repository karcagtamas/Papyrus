@using Papyrus.Shared.DTOs
@using Papyrus.Shared.Models
@using Services.Interfaces
@inject IStringLocalizer<UserEditDialog> L

<EditorDialog Model="UserModel" ModelObj="Model" EntityName="@L["Entity"]" IsEdit="true" Submit="Submit" FormValidator="ValidateForm">
    <MudTextField T="string" Label="@L["Field.UserName"]" Variant="Variant.Text" Required="true"
                  For="@(() => Model.UserName)" @bind-Value="Model.UserName" FullWidth="true">
    </MudTextField>
    <MudTextField T="string" Label="@L["Field.FullName"]" Variant="Variant.Text"
                  For="@(() => Model.FullName)" @bind-Value="Model.FullName" FullWidth="true">
    </MudTextField>
    <MudTextField T="string" Label="@L["Field.Email"]" Variant="Variant.Text" InputType="InputType.Email" Required="true"
                  For="@(() => Model.Email)" @bind-Value="Model.Email" FullWidth="true">
    </MudTextField>
    <MudDatePicker Label="@L["Field.BirthDay"]" Variant="Variant.Text"
                   For="@(() => Model.BirthDay)" @bind-Date="Model.BirthDay">
    </MudDatePicker>
</EditorDialog>


@code {
    [Parameter]
    public string UserId { get; set; } = default!;

    [Inject]
    private IUserService UserService { get; set; } = default!;

    private UserDTO? DTO { get; set; }
    private UserModel Model { get; set; } = new();

    protected override async void OnInitialized()
    {
        await GetUser();

        await base.OnInitializedAsync();
    }

    private async Task GetUser()
    {
        if (!string.IsNullOrEmpty(UserId))
        {
            DTO = await UserService.Get<UserDTO>(UserId);
            if (DTO is not null)
            {
                Model = new UserModel(DTO);
            }
            StateHasChanged();
        }
    }

    private Task<bool> Submit() => UserService.Update(UserId, Model);

    private async Task<bool> ValidateForm(UserModel model, ISnackbar snackbar)
    {
        if (string.IsNullOrEmpty(UserId))
        {
            return false;
        }

        if (UserNameOrEmailChanged(model) && await UserService.Exists(model.UserName, model.Email))
        {
            snackbar.Add(L["Message.AlreadyExists", model.UserName, model.Email], Severity.Error);
            return false;
        }

        return true;
    }

    private bool UserNameOrEmailChanged(UserModel model) => model.UserName != DTO?.UserName || model.Email != DTO?.Email;
}