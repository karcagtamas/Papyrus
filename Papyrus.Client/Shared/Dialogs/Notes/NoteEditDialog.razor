@using KarcagS.Blazor.Common.Services.Interfaces
@using KarcagS.Shared.Helpers
@using Papyrus.Client.Services.Notes.Interfaces
@using Papyrus.Shared.DTOs.Notes
@using Papyrus.Shared.Models.Notes
@inject IStringLocalizer<NoteEditDialog> L
@inject IHelperService Helper
@inject INoteService NoteService

<EditorDialog Model="NoteModel" ModelObj="Model" Submit="Submit" Remove="Remove" EntityName="@L["Entity"]" IsEdit="true" FormValidator="ValidateForm" RemoveDisabled="!DeleteEnabled">
    <TextInput Class="mb-5" Label="@L["Field.Title"]" Required For="@(() => Model.Title)" @bind-Value="Model.Title" FullWidth />
    <MudSwitch Class="mb-5" Color="Color.Primary" T="bool" Label="@L["Field.IsPublic"]" For="@(() => Model.Public)" @bind-Checked="Model.Public" />
    <MudSwitch Class="mb-5" Color="Color.Primary" T="bool" Label="@L["Field.IsArchived"]" For="@(() => Model.Archived)" @bind-Checked="Model.Archived" />
    <div>
        @foreach (var tag in Tags)
        {
            <TagBox Tag="tag" OnClose="@(() => RemoveTag(tag.Id))" />
        }
        <MudChip Style="height: 1.6rem;" Label="true" OnClick="AddTags">
            <MudTooltip Text="@L["Tooltip.Add"]">
                <MudIcon Size="Size.Small" Icon="@Icons.Material.Filled.Add" />
            </MudTooltip>
        </MudChip>
    </div>
</EditorDialog>

@code {
    [Parameter]
    public string NoteId { get; set; } = default!;

    [Parameter]
    public bool DeleteEnabled { get; set; } = false;

    [Parameter]
    public string ParentFolderId { get; set; } = default!;

    private NoteLightDTO? Note { get; set; }
    private NoteModel Model { get; set; } = new();
    private List<NoteTagDTO> Tags { get; set; } = new();

    protected override async void OnInitialized()
    {
        await base.OnInitializedAsync();

        Note = await NoteService.GetLight(NoteId);

        if (ObjectHelper.IsNotNull(Note))
        {
            Model = new(Note);
            Tags = Note.Tags;
            Model.Tags = Tags.Select(x => x.Id).ToList();

            await InvokeAsync(StateHasChanged);
        }
    }

    private Task<bool> Submit() => NoteService.Update(NoteId, Model);

    private Task<bool> Remove() => NoteService.Delete(NoteId);

    private async Task AddTags()
    {
        if (ObjectHelper.IsNull(Note))
        {
            return;
        }

        var result = await Helper.OpenDialog<TagTreeSelectorDialog, List<TagTreeItemDTO>>("Select Tag", (data) =>
        {
            if (ObjectHelper.IsNotEmpty(data))
            {
                var tags = data.Select(x => new NoteTagDTO
                    {
                        Id = x.Id,
                        Caption = x.Caption,
                        Color = x.Color
                    })
                .ToList();

                Tags.AddRange(tags);
                Model.Tags.AddRange(tags.Select(x => x.Id));
            }
        },
        new DialogParameters { { "GroupId", Note.GroupId }, { "DisabledIds", Model.Tags }, { "MultiSelect", true } });
    }

    private void RemoveTag(int id)
    {
        Tags = Tags.Where(x => x.Id != id).ToList();
        Model.Tags.Remove(id);
        StateHasChanged();
    }

    private async Task<bool> ValidateForm(NoteModel model, ISnackbar snackbar)
    {
        if (await NoteService.Exists(ParentFolderId, model.Title, NoteId))
        {
            snackbar.Add(L["Message.AlreadyExists", model.Title], Severity.Error);
            return false;
        }

        return true;
    }
}
