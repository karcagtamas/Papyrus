@using KarcagS.Shared.Helpers
@using Papyrus.Client.Services.Notes.Interfaces
@using Papyrus.Shared.DTOs.Notes
@using Papyrus.Shared.Models.Notes
@inject IStringLocalizer<FolderEditDialog> L
@inject IFolderService FolderService

<EditorDialog Model="FolderModel" ModelObj="Model" EntityName="@L["Entity"]" IsEdit="IsEdit" Submit="Submit" Remove="Remove" FormValidator="ValidateForm">
    <TextInput Class="mb-5" Label="@L["Field.Name"]" Required For="@(() => Model.Name)" @bind-Value="Model.Name" FullWidth />
</EditorDialog>

@code {
    [Parameter]
    public string? FolderId { get; set; }

    [Parameter]
    public string ParentFolderId { get; set; } = default!;

    [Parameter]
    public int? GroupId { get; set; }

    private FolderDTO? Folder { get; set; }
    private FolderModel Model { get; set; } = new();

    private bool IsEdit { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        if (ObjectHelper.IsNotNull(FolderId))
        {
            IsEdit = true;
            Folder = await FolderService.Get<FolderDTO>((string)FolderId);

            if (ObjectHelper.IsNotNull(Folder))
            {
                Model = new(Folder, ParentFolderId, GroupId);

                await InvokeAsync(StateHasChanged);
            }
        }

        Model.ParentId = ParentFolderId;
        await InvokeAsync(StateHasChanged);
    }

    private Task<bool> Submit()
    {
        if (IsEdit)
        {
            if (ObjectHelper.IsNotNull(FolderId))
            {
                return FolderService.Update((string)FolderId, Model);
            }
        }
        else
        {
            return FolderService.Create(Model);
        }

        return Task.FromResult(false);
    }

    private Task<bool> Remove()
    {
        if (ObjectHelper.IsNotNull(FolderId))
        {
            return FolderService.Delete((string)FolderId);
        }

        return Task.FromResult(false);
    }

    private async Task<bool> ValidateForm(FolderModel model, ISnackbar snackbar)
    {
        if (await FolderService.Exists(ParentFolderId, model.Name))
        {
            snackbar.Add(L["Message.AlreadyExists", model.Name], Severity.Error);
            return false;
        }

        return true;
    }
}
