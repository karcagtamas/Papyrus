@using KarcagS.Shared.Helpers
@using Papyrus.Client.Services.Notes.Interfaces
@using Papyrus.Shared.DTOs.Notes
@using Papyrus.Shared.Models.Notes
@inject IStringLocalizer<FolderEditDialog> L
@inject IFolderService FolderService

<EditorDialog Model="FolderModel" ModelObj="Model" Submit="Submit" Remove="Remove" EntityName="@L["Entity"]" IsEdit="IsEdit">
    <TextInput Class="mb-5" Label="@L["Field.Name"]" Required For="@(() => Model.Name)" @bind-Value="Model.Name" FullWidth />
</EditorDialog>

@code {
    [Parameter]
    public string? FolderId { get; set; }

    [Parameter]
    public string ParentFolderId { get; set; } = default!;

    [Parameter]
    public int? GroupId { get; set; }

    private FolderDTO? Folder { get; set; }
    private FolderModel Model { get; set; } = new();

    private bool IsEdit { get; set; } = false;

    protected override void OnInitialized()
    {
        base.OnInitialized();

        ObjectHelper.WhenNotNull(FolderId, async id =>
        {
            Folder = await FolderService.Get<FolderDTO>(id);

            if (ObjectHelper.IsNotNull(Folder))
            {
                IsEdit = true;
                Model = new(Folder, ParentFolderId, GroupId);

                await InvokeAsync(StateHasChanged);
            }
        });

        Model.ParentId = ParentFolderId;
    }

    private Task<bool> Submit()
    {
        // TODO: Add form validator => unique folder names on same level
        if (IsEdit)
        {
            if (ObjectHelper.IsNotNull(FolderId))
            {
                return FolderService.Update((string)FolderId, Model);
            }
        }
        else
        {
            return FolderService.Create(Model);
        }

        return Task.FromResult(false);
    }

    private Task<bool> Remove()
    {
        if (ObjectHelper.IsNotNull(FolderId))
        {
            return FolderService.Delete((string)FolderId);
        }

        return Task.FromResult(false);
    }
}
