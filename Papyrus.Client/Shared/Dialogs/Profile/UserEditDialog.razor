@using Papyrus.Shared.DTOs
@using Papyrus.Shared.Models
@using Services.Interfaces
@inject IStringLocalizer<UserEditDialog> L

<EditorDialog Model="UserModel" ModelObj="Model" EntityName="@L["Entity"]" IsEdit="true" Submit="Submit" FormValidator="ValidateForm">
    <TextInput Class="mb-5" Label="@L["Field.UserName"]" Required For="@(() => Model.UserName)" @bind-Value="Model.UserName" FullWidth/>
    <TextInput Class="mb-5" Label="@L["Field.FullName"]" For="@(() => Model.FullName)" @bind-Value="Model.FullName" FullWidth />
    <TextInput Class="mb-5" Label="@L["Field.Email"]" IsEmail Required For="@(() => Model.Email)" @bind-Value="Model.Email" FullWidth />
    <DateInput Label="@L["Field.BirthDay"]" For="@(() => Model.BirthDay)" @bind-Date="Model.BirthDay" />
</EditorDialog>


@code {
    [Parameter]
    public string UserId { get; set; } = default!;

    [Inject]
    private IUserService UserService { get; set; } = default!;

    private UserDTO? DTO { get; set; }
    private UserModel Model { get; set; } = new();

    protected override async void OnInitialized()
    {
        await base.OnInitializedAsync();

        await GetUser();
    }

    private async Task GetUser()
    {
        if (!string.IsNullOrEmpty(UserId))
        {
            DTO = await UserService.Get<UserDTO>(UserId);
            if (ObjectHelper.IsNotNull(DTO))
            {
                Model = new UserModel(DTO);
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private Task<bool> Submit() => UserService.Update(UserId, Model);

    private async Task<bool> ValidateForm(UserModel model, ISnackbar snackbar)
    {
        if (string.IsNullOrEmpty(UserId))
        {
            return false;
        }

        if (UserNameOrEmailChanged(model) && await UserService.Exists(model.UserName, model.Email))
        {
            snackbar.Add(L["Message.AlreadyExists", model.UserName, model.Email], Severity.Error);
            return false;
        }

        return true;
    }

    private bool UserNameOrEmailChanged(UserModel model) => model.UserName != DTO?.UserName || model.Email != DTO?.Email;
}
