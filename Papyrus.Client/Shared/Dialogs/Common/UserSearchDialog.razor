@using KarcagS.Shared.Helpers
@using Papyrus.Client.Services.Interfaces
@using Papyrus.Shared.DTOs
@inject IStringLocalizer<UserSearchDialog> L

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h5" Color="Color.Primary">@L["Title"]</MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField T="string" Placeholder="@L["SearchPlaceholder"]" TextChanged="(value) => Fetch(value)" />

        @if (Users.Count > 0 && !IsLoading)
        {
            <MudTable Style="margin-top: 2rem;" T="UserLightDTO" Items="Users" @bind-SelectedItem="Selected" Dense="true" Striped="true" OnRowClick="(e) => Selected = e.Item" RowClassFunc="RowClassFunc">
                <HeaderContent>
                    <MudTh>
                        <MudText Color="Color.Primary">User Name</MudText>
                    </MudTh>
                    <MudTh>
                        <MudText Color="Color.Primary">E-mail</MudText>
                    </MudTh>
                    <MudTh>
                        <MudText Color="Color.Primary">Full Name</MudText>
                    </MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="UserName">@context.UserName</MudTd>
                    <MudTd DataLabel="Email">@context.Email</MudTd>
                    <MudTd DataLabel="FullName">@WriteHelper.WriteNullableField(context.FullName)</MudTd>
                </RowTemplate>
            </MudTable>
        }
        else
        {
            <MudText Color="@(IsError ? Color.Error : Color.Warning)" Class="w-100 mt-5 text-center flex-box justify-content-center align-items-center flex-row gap-1">
                <MudIcon Icon="@Icons.Filled.Info" />
                @Message
            </MudText>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">@L["CloseAction"]</MudButton>
        <MudButton Color="Color.Primary" OnClick="Select">@L["SelectAction"]</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private MudDialogInstance Dialog { get; set; } = null!;

    [Parameter]
    public List<string> Ignored { get; set; } = new();

    [Inject]
    private IUserService UserService { get; set; } = default!;

    private List<UserLightDTO> Users = new();
    private UserLightDTO? Selected = null;
    private bool IsLoading { get; set; } = false;
    private string Message { get; set; } = string.Empty;
    private bool IsError { get; set; }

    protected override void OnInitialized()
    {
        Message = L["Message.Empty"];
        base.OnInitialized();
    }

    private async Task Fetch(string value)
    {
        if (string.IsNullOrEmpty(value))
        {
            Users = new();
            Selected = null;
            Message = L["Message.Empty"];
            IsError = false;
            return;
        }

        IsLoading = true;
        await InvokeAsync(StateHasChanged);
        Users = await UserService.Search(value, true, Ignored);
        Selected = null;
        IsLoading = false;
        Message = Users.Count() > 0 ? "" : L["Message.NotFound"];
        IsError = true;
        await InvokeAsync(StateHasChanged);
    }

    private string RowClassFunc(UserLightDTO dto, int index)
    {
        if (Selected is null)
        {
            return "";
        }

        return dto.Id == Selected.Id ? "mud-info" : "";
    }

    private void Select()
    {
        if (Selected is not null)
        {
            Dialog.Close(Selected.Id);
        }
    }

    private void Cancel()
    {
        Dialog.Cancel();
    }
}