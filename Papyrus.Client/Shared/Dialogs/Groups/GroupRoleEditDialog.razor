@using KarcagS.Shared.Helpers
@using Papyrus.Client.Services.Groups.Interfaces
@using Papyrus.Shared.DTOs.Groups
@using Papyrus.Shared.Models.Groups
@inject IStringLocalizer<GroupRoleEditDialog> L

<EditorDialog Model="GroupRoleModel" ModelObj="Model" Submit="Submit" Remove="Remove" EntityName="@L["Entity"]" IsEdit="IsEdit" FormValidator="ValidateForm">
    <MudTextField Class="mb-5" T="string" Label="@L["Field.Name"]" Variant="Variant.Text" Required="true"
                  For="@(() => Model.Name)" @bind-Value="Model.Name" FullWidth="true" />
    <MudDivider />
    <div class="d-flex flex-row">
        <MudCheckBox Label="@L["Field.GroupEdit"]" For="@(() => Model.GroupEdit)" @bind-Checked="Model.GroupEdit" />
        <MudCheckBox Label="@L["Field.GroupClose"]" For="@(() => Model.GroupClose)" @bind-Checked="Model.GroupClose" />
    </div>
    <MudDivider />
    <div class="d-flex flex-row">
        <MudCheckBox Label="@L["Field.ReadNotes"]" For="@(() => Model.ReadNoteList)" @bind-Checked="Model.ReadNoteList" />
        <MudCheckBox Label="@L["Field.ReadNote"]" For="@(() => Model.ReadNote)" @bind-Checked="Model.ReadNote" />
        <MudCheckBox Label="@L["Field.CreateNote"]" For="@(() => Model.CreateNote)" @bind-Checked="Model.CreateNote" />
        <MudCheckBox Label="@L["Field.DeleteNote"]" For="@(() => Model.DeleteNote)" @bind-Checked="Model.DeleteNote" />
        <MudCheckBox Label="@L["Field.EditNote"]" For="@(() => Model.EditNote)" @bind-Checked="Model.EditNote" />
    </div>
    <MudDivider />
    <div class="d-flex flex-row">
        <MudCheckBox Label="@L["Field.ReadMembers"]" For="@(() => Model.ReadMemberList)" @bind-Checked="Model.ReadMemberList" />
        <MudCheckBox Label="@L["Field.EditMembers"]" For="@(() => Model.EditMemberList)" @bind-Checked="Model.EditMemberList" />
    </div>
    <MudDivider />
    <div class="d-flex flex-row">
        <MudCheckBox Label="@L["Field.ReadRoles"]" For="@(() => Model.ReadRoleList)" @bind-Checked="Model.ReadRoleList" />
        <MudCheckBox Label="@L["Field.EditRoles"]" For="@(() => Model.EditRoleList)" @bind-Checked="Model.EditRoleList" />
    </div>
    <MudDivider />
    <div class="d-flex flex-row">
        <MudCheckBox Label="@L["Field.ReadLogs"]" For="@(() => Model.ReadGroupActionLog)" @bind-Checked="Model.ReadGroupActionLog" />
        <MudCheckBox Label="@L["Field.ReadNoteLogs"]" For="@(() => Model.ReadNoteActionLog)" @bind-Checked="Model.ReadNoteActionLog" />
    </div>
    <MudDivider />
    <div class="d-flex flex-row">
        <MudCheckBox Label="@L["Field.ReadTags"]" For="@(() => Model.ReadTagList)" @bind-Checked="Model.ReadTagList" />
        <MudCheckBox Label="@L["Field.EditTags"]" For="@(() => Model.EditTagList)" @bind-Checked="Model.EditTagList" />
    </div>
</EditorDialog>

@code {
    [Parameter]
    public int? GroupRoleId { get; set; }

    [Parameter]
    public int GroupId { get; set; }

    [Inject]
    private IGroupRoleService GroupRoleService { get; set; } = default!;

    private GroupRoleDTO? GroupRole { get; set; }
    private GroupRoleModel Model { get; set; } = new(0);
    private bool IsEdit { get; set; } = false;

    protected override async void OnInitialized()
    {
        Model.GroupId = GroupId;
        if (ObjectHelper.IsNotNull(GroupRoleId))
        {
            IsEdit = true;
            GroupRole = await GroupRoleService.Get<GroupRoleDTO>((int)GroupRoleId);

            if (ObjectHelper.IsNotNull(GroupRole))
            {
                Model = new GroupRoleModel(GroupId, GroupRole);
                await InvokeAsync(StateHasChanged);
            }

        }
        base.OnInitialized();
    }

    private Task<bool> Submit()
    {
        if (IsEdit && ObjectHelper.IsNotNull(GroupRoleId))
        {
            return GroupRoleService.Update((int)GroupRoleId, Model);
        }

        return GroupRoleService.Create(Model);
    }

    private Task<bool> Remove()
    {
        if (ObjectHelper.IsNotNull(GroupRoleId))
        {
            return GroupRoleService.Delete((int)GroupRoleId);
        }

        return Task.FromResult(false);
    }

    private async Task<bool> ValidateForm(GroupRoleModel model, ISnackbar snackbar)
    {
        if (ObjectHelper.IsNotNull(GroupRole) && model.Name != GroupRole.Name && await GroupRoleService.Exists(GroupId, model.Name))
        {
            snackbar.Add(L["Message.AlreadyExists", model.Name], Severity.Error);
            return false;
        }

        return true;
    }
}
