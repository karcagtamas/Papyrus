@using Papyrus.Client.Services.Groups.Interfaces
@using Papyrus.Shared.DTOs.Groups
@using Papyrus.Shared.Models.Groups
@inject IStringLocalizer<GroupMemberEditDialog> L

<EditorDialog Model="GroupMemberUpdateModel" ModelObj="Model" Submit="Submit" Remove="Remove" EntityName="@L["Entity"]" IsEdit="true">
    <MudSelect T="int" Label="@L["Field.Role"]" Variant="Variant.Text" Required="true"
               For="@(() => Model.RoleId)" @bind-Value="Model.RoleId" FullWidth="true">
        @foreach (var role in Roles)
        {
            <MudSelectItem Value="@role.Id">@role.Name</MudSelectItem>
        }
    </MudSelect>
</EditorDialog>

@code {
    [Parameter]
    public int GroupId { get; set; }

    [Parameter]
    public int MemberId { get; set; } = default!;

    [Inject]
    private IGroupService GroupService { get; set; } = default!;

    [Inject]
    private IGroupMemberService GroupMemberService { get; set; } = default!;

    [Inject]
    private IGroupRoleService GroupRoleService { get; set; } = default!;

    private GroupMemberUpdateModel Model { get; set; } = new();
    private GroupMemberDTO? Member { get; set; }
    private List<GroupRoleLightDTO> Roles { get; set; } = new();

    protected override async void OnInitialized()
    {
        Roles = await GroupRoleService.GetLightByGroup(GroupId);
        Member = await GroupMemberService.Get<GroupMemberDTO>(MemberId);
        await InvokeAsync(StateHasChanged);

        if (ObjectHelper.IsNotNull(Member))
        {
            Model = new GroupMemberUpdateModel
                {
                    RoleId = Member.Role.Id,
                };
            await InvokeAsync(StateHasChanged);
        }

        base.OnInitialized();
    }

    private Task<bool> Submit() => GroupMemberService.Update(MemberId, Model);

    private Task<bool> Remove() => GroupMemberService.Delete(MemberId);
}
