@using KarcagS.Blazor.Common.Services
@using KarcagS.Shared.Helpers
@using MudBlazor.Utilities
@using Papyrus.Client.Services.Notes.Interfaces
@using Papyrus.Shared.DTOs.Groups
@using Papyrus.Shared.DTOs.Notes
@using Papyrus.Shared.Models.Groups
@using System.ComponentModel.DataAnnotations

<EditorDialog Model="GroupTagModel" ModelObj="Model" Submit="Submit" Remove="Remove" EntityName="Group Tag" IsEdit="IsEdit">
    <MudText Class="@("text-center mt-3 mb-3 " + (IsEdit ? "hovered-text" : ""))" Color="Color.Primary" onclick="@(() => EditParent())"><b>@Path?.Path/</b></MudText>
    <MudTextField Class="mb-5" T="string" Label="Caption" Variant="Variant.Text" Required="true"
                  For="@(() => Model.Caption)" @bind-Value="Model.Caption" FullWidth="true" />

    <MudTextField Class="mb-5" T="string" Label="Description" Variant="Variant.Text"
                  For="@(() => Model.Description)" @bind-Value="Model.Description" FullWidth="true" Lines="5" />

    <MudColorPicker Class="mb-5" Label="Color" Variant="Variant.Text" @bind-Text="Model.Color" />
</EditorDialog>

@code {
    [Parameter]
    public int? TagId { get; set; }

    [Parameter]
    public int GroupId { get; set; }

    [Parameter]
    public int? ParentId { get; set; }

    [Inject]
    private ITagService TagService { get; set; } = default!;

    [Inject]
    private IHelperService HelperService { get; set; } = default!;

    private TagDTO? Tag { get; set; }
    private GroupTagModel Model { get; set; } = new();
    private TagPathDTO? Path { get; set; }
    private bool IsEdit { get; set; } = false;
    private int? OriginalParentId { get; set; }

    protected override async void OnInitialized()
    {
        Model.GroupId = GroupId;
        Model.ParentId = ParentId;
        if (TagId is not null)
        {
            IsEdit = true;
            Tag = await TagService.Get<TagDTO>((int)TagId);

            if (Tag is not null)
            {
                Model = new GroupTagModel(GroupId, Tag);
                Model.ParentId = Tag.ParentId;
                await InvokeAsync(StateHasChanged);
            }

        }

        FetchPath();

        OriginalParentId = Model.ParentId;

        base.OnInitialized();
    }

    private void FetchPath()
    {
        ObjectHelper.WhenNotNull(Model.ParentId, async (o) =>
        {
            Path = await TagService.GetPath((int)o!);
            await InvokeAsync(StateHasChanged);
        });
    }

    private Task<bool> Submit()
    {
        if (IsEdit && TagId is not null)
        {
            return TagService.UpdateGroupTag((int)TagId, Model);
        }

        return TagService.CreateGroupTag(Model);
    }

    private Task<bool> Remove()
    {
        if (TagId is not null)
        {
            return TagService.Delete((int)TagId);
        }

        return Task.FromResult(false);
    }

    private async Task EditParent()
    {
        if (!IsEdit)
        {
            return;
        }

        var result = await HelperService.OpenDialog<GroupTagTreeSelectorDialog, List<GroupTagTreeItemDTO>>("Select Tag", new DialogParameters { { "GroupId", GroupId }, { "ParentId", OriginalParentId is null ? TagId : OriginalParentId } }, null, () => { });

        if (result is not null && result.Count > 0)
        {
            Model.ParentId = result[0].Id;
            FetchPath();
        }
        else
        {
            Model.ParentId = null;
            Path = null;
            await InvokeAsync(StateHasChanged);
        }
    }
}
