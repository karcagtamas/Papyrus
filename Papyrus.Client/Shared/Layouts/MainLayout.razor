@using KarcagS.Blazor.Common.Store
@using Papyrus.Client.Services.Auth.Interfaces
@using Papyrus.Client.Shared
@using Papyrus.Shared.DTOs
@using Papyrus.Client.Services.Interfaces
@using System.Text.RegularExpressions
@using static Papyrus.Client.Shared.PapyrusMenu
@inherits LayoutComponentBase
@implements IDisposable
@inject IUserService userService
@inject IAuthService auth
@inject NavigationManager navigator
@inject AuthenticationStateProvider authStateProvider
@inject IStoreService store

<MudThemeProvider Theme="@PapyrusTheme.GetTheme()" />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout Class="flex-box">
    <MudAppBar Elevation="1" Dense="true" Color="Color.Primary">
        <AuthorizeView>
            <Authorized>
                <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start"
                               OnClick="@((_) => DrawerToggle())" Class="mr-5" />
            </Authorized>
        </AuthorizeView>
        <MudLink Color="Color.Inherit" Class="mr-5 ml-5 mud-nav-link-text appbar-title" Href="/home">
            @PapyrusContext.ApplicationName
        </MudLink>
        <MudSpacer />
        <AuthorizeView>
            <Authorized>
                @if (User is not null)
                {
                    <MudText Typo="Typo.caption">@User.UserName</MudText>
                    <MudAvatar Color="Color.Secondary" Class="ml-3">@User.UserName.ToUpper()[0]</MudAvatar>
                }
            </Authorized>
        </AuthorizeView>
    </MudAppBar>
    <AuthorizeView>
        <Authorized>
            <MudDrawer @bind-Open="@drawerOpen" Elevation="2" ClipMode="DrawerClipMode.Always" Class="drawer">
                <NavMenu MenuItems="MenuItems" GroupMenuItems="GroupMenuItems" />
            </MudDrawer>
        </Authorized>
    </AuthorizeView>
    <MudMainContent Class="flex-box overflow-hidden">
        @Body
    </MudMainContent>
</MudLayout>

@code {
    private UserDTO? User { get; set; }
    private int? GroupId { get; set; }
    private List<MenuItem> MenuItems { get; set; } = new();
    private List<MenuItem> GroupMenuItems { get; set; } = new();

    bool drawerOpen = true;

    void DrawerToggle()
    {
        drawerOpen = !drawerOpen;
    }

    protected override async void OnInitialized()
    {
        HandleAuthStateChange(authStateProvider.GetAuthenticationStateAsync());
        SetGroupMenuItemsByLocation(navigator.Uri);

        authStateProvider.AuthenticationStateChanged += HandleAuthStateChange;
        navigator.LocationChanged += HandleLocationChange;

        MenuItems = PapyrusMenu.Items;

        await base.OnInitializedAsync();
    }

    private void HandleLocationChange(object? sender, LocationChangedEventArgs e)
    {
        SetGroupMenuItemsByLocation(e.Location);
    }

    private void SetGroupMenuItemsByLocation(string location)
    {
        var uri = navigator.ToBaseRelativePath(location);
        var regex = new Regex(@"groups\/([0-9]+)\/?[/a-z]*");
        var matches = regex.Matches(uri);

        foreach (Match match in matches)
        {
            if (match.Groups.Count == 2)
            {
                Group g = match.Groups[1];
                int.TryParse(g.Value, out int id);

                SetGroupId(id);
            }
            else
            {
                SetGroupId(null);
            }
        }

        if (matches.Count == 0)
        {
            if (GroupId is not null)
            {
                SetGroupId(null);
            }
        }
    }

    private void SetGroupId(int? id)
    {
        if (id is null)
        {
            GroupId = null;
            GroupMenuItems = new();
            store.Remove("GroupId");
            StateHasChanged();
        }
        else
        {
            if (GroupId != id)
            {
                GroupId = id;
                GroupMenuItems = PapyrusMenu.BuildGroupItems((int)id);
                store.Add("GroupId", id);
                StateHasChanged();
            }
        }
    }

    private async void HandleAuthStateChange(Task<AuthenticationState> state)
    {
        var s = await state;

        bool isAuthenticated = s.User.Identity?.Name is not null;
        string uri = navigator.ToBaseRelativePath(navigator.Uri);

        if (!isAuthenticated)
        {
            var inTree = UriIsAuthenticated(PapyrusMenu.Items, uri);

            if (inTree)
            {
                auth.NotAuthorized();
            }
        }

        GetUserFromState(s);
    }

    private bool UriIsAuthenticated(List<MenuItem> items, string uri)
    {
        return items.Where(x => x.Authenticated).Any(x => x.Path == uri || UriIsAuthenticated(x.Children, uri));
    }

    private async void GetUserFromState(AuthenticationState state)
    {
        if (state.User.Identity?.Name is not null)
        {
            User = await userService.Current();
            await InvokeAsync(StateHasChanged);
        }
    }

    void IDisposable.Dispose()
    {
        authStateProvider.AuthenticationStateChanged -= HandleAuthStateChange;
        navigator.LocationChanged -= HandleLocationChange;
    }

}