@using KarcagS.Blazor.Common.Store
@using Papyrus.Client.Services.Auth.Interfaces
@using Papyrus.Client.Shared
@using Papyrus.Shared.DTOs
@using Papyrus.Client.Services.Interfaces
@using static Papyrus.Client.Shared.PapyrusMenu
@inherits LayoutComponentBase
@implements IDisposable
@inject IUserService userService
@inject IAuthService auth
@inject NavigationManager navigator
@inject AuthenticationStateProvider authStateProvider
@inject IStoreService store

<MudThemeProvider Theme="@PapyrusTheme.GetTheme()" />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout Class="flex-box">
    <MudAppBar Elevation="1" Dense="true" Color="Color.Primary">
        <AuthorizeView>
            <Authorized>
                <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start"
                               OnClick="@((_) => DrawerToggle())" Class="mr-5" />
            </Authorized>
        </AuthorizeView>
        <MudLink Color="Color.Inherit" Class="mr-5 ml-5 mud-nav-link-text appbar-title" Href="/home">
            @PapyrusContext.ApplicationName
        </MudLink>
        <MudSpacer />
        <AuthorizeView>
            <Authorized>
                @if (User is not null)
                {
                    <MudText Typo="Typo.caption">@User.UserName</MudText>
                    <MudAvatar Color="Color.Secondary" Class="ml-3">@User.UserName.ToUpper()[0]</MudAvatar>
                }
            </Authorized>
        </AuthorizeView>
    </MudAppBar>
    <AuthorizeView>
        <Authorized>
            <MudDrawer @bind-Open="@drawerOpen" Elevation="2" ClipMode="DrawerClipMode.Always" Class="drawer">
                <NavMenu MenuItems="MenuItems" GroupMenuItems="GroupMenuItems" />
            </MudDrawer>
        </Authorized>
    </AuthorizeView>
    <MudMainContent Class="flex-box overflow-hidden">
        @Body
    </MudMainContent>
</MudLayout>

@code {
    private UserDTO? User { get; set; }
    private int? GroupId { get; set; }
    private List<MenuItem> MenuItems { get; set; } = new();
    private List<MenuItem> GroupMenuItems { get; set; } = new();

    bool drawerOpen = true;

    void DrawerToggle()
    {
        drawerOpen = !drawerOpen;
    }

    protected override async void OnInitialized()
    {
        HandleAuthStateChange(authStateProvider.GetAuthenticationStateAsync());
        RefreshGroupItemsByStore();

        authStateProvider.AuthenticationStateChanged += HandleAuthStateChange;
        store.Changed += HandleStoreChange;

        MenuItems = PapyrusMenu.Items;

        await base.OnInitializedAsync();
    }

    private void HandleStoreChange(object? sender, EventArgs e)
    {
        RefreshGroupItemsByStore();
    }

    private void RefreshGroupItemsByStore()
    {
        if (store.IsExists("GroupId"))
        {
            var id = store.Get<int>("GroupId");

            if (GroupId != id)
            {
                GroupId = id;

                // Build Group Items
                GroupMenuItems = PapyrusMenu.BuildGroupItems((int)GroupId);

                StateHasChanged();
            }
        }
        else
        {
            GroupId = null;
            GroupMenuItems = new();
            StateHasChanged();
        }
    }

    private async void HandleAuthStateChange(Task<AuthenticationState> state)
    {
        var s = await state;

        bool isAuthenticated = s.User.Identity?.Name is not null;
        string uri = navigator.ToBaseRelativePath(navigator.Uri);

        if (!isAuthenticated)
        {
            var inTree = UriIsAuthenticated(PapyrusMenu.Items, uri);

            if (inTree)
            {
                auth.NotAuthorized();
            }
        }

        GetUserFromState(s);
    }

    private bool UriIsAuthenticated(List<MenuItem> items, string uri)
    {
        return items.Where(x => x.Authenticated).Any(x => x.Path == uri || UriIsAuthenticated(x.Children, uri));
    }

    private async void GetUserFromState(AuthenticationState state)
    {
        if (state.User.Identity?.Name is not null)
        {
            User = await userService.Current();
            await InvokeAsync(StateHasChanged);
        }
    }

    void IDisposable.Dispose()
    {
        authStateProvider.AuthenticationStateChanged -= HandleAuthStateChange;
        store.Changed -= HandleStoreChange;
    }

}