@using KarcagS.Blazor.Common.Services.Interfaces
@using Papyrus.Client.Services.Notes.Interfaces
@using Papyrus.Shared.DTOs.Notes
@using Papyrus.Shared.Enums.Notes
@using Papyrus.Shared.Models.Notes
@inject IStringLocalizer<NoteList> L
@inject INoteService NoteService
@inject IFolderService FolderService
@inject ITagService TagService
@inject IHelperService Helper
@inject IJSRuntime JSRuntime

<ActionBar>
    <ChildContent>
        <div>
            @if (CreateEnabled)
            {
                <MudButton Color="Color.Secondary" Variant="Variant.Filled" OnClick="Create">@L["CreateAction"]</MudButton>
                <MudButton Color="Color.Secondary" Variant="Variant.Filled" OnClick="CreateFolder">@L["CreateFolderAction"]</MudButton>
            }
        </div>
        <MudSpacer />
        <MudRadioGroup Class="mr-3" T="bool" SelectedOption="QueryModel.ArchivedStatus" SelectedOptionChanged="HandleArchivedStatusChange">
            <MudRadio Size="Size.Small" Option="true">@L["ArchivedStatus.Archived"]</MudRadio>
            <MudRadio Size="Size.Small" Option="false">@L["ArchivedStatus.NotArchived"]</MudRadio>
        </MudRadioGroup>
        <MudRadioGroup T="NotePublishType" SelectedOption="QueryModel.PublishType" SelectedOptionChanged="HandlePublishTypeChange">
            <MudRadio Size="Size.Small" Option="NotePublishType.All">@L["PublishType.All"]</MudRadio>
            <MudRadio Size="Size.Small" Option="NotePublishType.Published">@L["PublishType.Published"]</MudRadio>
            <MudRadio Size="Size.Small" Option="NotePublishType.NotPublished">@L["PublishType.NotPublished"]</MudRadio>
        </MudRadioGroup>
    </ChildContent>
    <OtherRows>
        <div class="d-flex flex-row w-100">
            <div></div>
            <MudSpacer />
            @if (ObjectHelper.IsNotEmpty(Tags))
            {
                <div class="mr-3">
                    <MudSelect T="int" Style="width: 420px;" SelectedValues="QueryModel.Tags.AsEnumerable()" SelectedValuesChanged="HandleTagFilterChange" Variant="Variant.Outlined" Dense Margin="Margin.Dense" Clearable MultiSelection MultiSelectionTextFunc="ConstructTagText" Placeholder="@L["TagFilter.Placeholder"]">
                        @foreach (var tag in Tags)
                        {
                            <MudSelectItem @key="tag.Id" Value="tag.Id"><TagBox Tag="tag" /></MudSelectItem>
                        }
                    </MudSelect>
                </div>
            }
            <div class="mr-3">
                <DateInput Label="" Style="width: 260px" Date="QueryModel.DateFilter" DateChanged="HandleDateFilterChange" Clearable Placeholder="@L["DateFilter.Placeholder"]" />
            </div>
            <div>
                <TextInput Label="" Style="width: 260px" Value="@QueryModel.TextFilter" ValueChanged="HandleTextFilterChange" Clearable Placeholder="@L["TextFilter.Placeholder"]" />
            </div>
        </div>
    </OtherRows>
</ActionBar>
<div class="page-content">
    <div>
        <MudGrid>
            @foreach(var folder in Content.Folders)
            {
                <MudItem @key="folder.Id" xs="6" sm="4" md="3" lg="2" xl="1">
                    <NoteListFolderTile Folder="folder" />
                </MudItem>
            }
        </MudGrid>
        <MudGrid>
            @foreach (var note in Content.Notes)
            {
                <MudItem @key="note.Id" xs="6" sm="4" md="3" lg="2" xl="1">
                    <NoteListNoteTile Note="note" />
                </MudItem>
            }
        </MudGrid>
    </div>
    <div class="notes">
        @foreach (var note in List)
        {
            <NoteListTile @key="note.Id" Note="note" />
        }
    </div>
</div>

@code {
    [Parameter]
    public int? GroupId { get; set; } = null;

    [Parameter, EditorRequired]
    public Func<NoteFilterQueryModel, Task<List<NoteLightDTO>>> Fetcher { get; set; } = (query) => Task.FromResult(new List<NoteLightDTO>());

    [Parameter]
    public string? Folder { get; set; }

    [Parameter]
    public EventCallback Refreshed { get; set; }

    [Parameter]
    public bool CreateEnabled { get; set; } = true;

    [Parameter]
    public bool OpenDisabled { get; set; } = false;

    private NoteFilterQueryModel QueryModel { get; set; } = new();
    private List<NoteLightDTO> List { get; set; } = new();
    private List<NoteTagDTO> Tags { get; set; } = new();
    private FolderContentDTO Content { get; set; } = new FolderContentDTO { ParentFolder = new(), Folders = new(), Notes = new() };

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        Tags = await TagService.GetList(GroupId);

        await Refresh();
    }

    private async Task Refresh()
    {
        List = await Fetcher(QueryModel);
        Content = await FolderService.GetContent(Folder, GroupId);
        await Refreshed.InvokeAsync();

        await InvokeAsync(StateHasChanged);
    }

    private async Task Create()
    {
        if (!CreateEnabled)
        {
            return;
        }

        var result = await NoteService.CreateEmpty(GroupId);

        if (ObjectHelper.IsNotNull(result))
        {
            await Refreshed.InvokeAsync();
            await JSRuntime.InvokeAsync<object>("open", $"/notes/editor/{result.Id}", "_blank");
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task CreateFolder()
    {
        var parameters = new DialogParameters {{ "FolderId", null }, { "ParentFolderId", Content.ParentFolder.Id }, { "GroupId", GroupId }};

        await Helper.OpenEditorDialog<FolderEditDialog>("", (res) => {}, parameters);
    }

    private string ConstructTagText(List<string> list)
    {
        var ids = list.Select(x => int.Parse(x)).ToList();
        return string.Join(", ", Tags.Where(x => ids.Contains(x.Id)).Select(x => x.Caption).ToList());
    }

    private async Task HandlePublishTypeChange(NotePublishType publishType)
    {
        QueryModel.PublishType = publishType;
        await Refresh();
    }

    private async Task HandleArchivedStatusChange(bool status)
    {
        QueryModel.ArchivedStatus = status;
        await Refresh();
    }

    private async Task HandleTextFilterChange(string text)
    {
        QueryModel.TextFilter = string.IsNullOrEmpty(text) ? null : text;
        await Refresh();
    }

    private async Task HandleDateFilterChange(DateTime? date)
    {
        QueryModel.DateFilter = date;
        await Refresh();
    }

    private async Task HandleTagFilterChange(IEnumerable<int> tags)
    {
        QueryModel.Tags = tags.ToList();
        await Refresh();
    }
}
