@using System.Globalization
@using Papyrus.Client.Services.Interfaces
@using Papyrus.Shared.DTOs
@inject NavigationManager Navigator
@inject IJSRuntime JS
@inject ILanguageService LanguageService

<MudMenu Class="@Class" Label="@Current.ShortName" Color="Color" Variant="Variant" Dense="true" StartIcon="@Icons.Filled.Language" EndIcon="@Icons.Filled.KeyboardArrowDown" DisableElevation="true" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
    @foreach (var lang in Languages)
    {
        <MudMenuItem OnClick="@(() => UpdateLanguage(lang))"><MudText Color="@(Current.Id == lang.Id ? Color.Primary : Color.Default)">@lang.ShortName</MudText></MudMenuItem>
    }
</MudMenu>

@code {
    [Parameter]
    public Color Color { get; set; } = Color.Primary;

    [Parameter]
    public Variant Variant { get; set; } = Variant.Filled;

    [Parameter]
    public string Class { get; set; } = default!;

    private List<LanguageDTO> Languages { get; set; } = new();
    private LanguageDTO Current { get; set; } = new LanguageDTO { Id = 0, Name = "<NOT FOUND>", ShortName = "-" };

    protected override async void OnInitialized()
    {
        Languages = await LanguageService.GetAll<LanguageDTO>();
        var current = Languages.FirstOrDefault(x => x.ShortName == CultureInfo.CurrentCulture.Name);

        ObjectHelper.WhenNotNull(current, c => Current = c);

        base.OnInitialized();
        StateHasChanged();
    }

    private async Task UpdateLanguage(LanguageDTO language)
    {
        await LanguageService.SetUserLanguage(language.Id);
        var js = (IJSInProcessRuntime)JS;
        js.InvokeVoid("blazorCulture.set", language.ShortName);

        Navigator.NavigateTo(Navigator.Uri, forceLoad: true);
    }
}
