@page "/login"
@using KarcagS.Shared.Helpers
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.Extensions.Localization
@using Papyrus.Client.Services.Interfaces
@using Papyrus.Shared.Models.Auth
@using Papyrus.Client.Services.Auth.Interfaces
@layout AuthLayout
@inject NavigationManager NavigationManager
@inject IAuthService AuthService
@inject IStringLocalizer<Login> L

<ApplicationPageTitle PageName="@L["PageName"]"></ApplicationPageTitle>

<div id="panel">
    <MudPaper Class="p-4" Elevation="4">
        <MudText Typo="Typo.h4" Color="Color.Primary">@L["Title"]</MudText>

        <div id="image">
            <img src="assets/images/main.svg" alt="@L["Image"]" />
        </div>

        <MudForm @ref="form" Model="Model">
            <MudTextField T="string" Label="@L["Field.UserName"]" Variant="Variant.Text" Required="true"
                          For="@(() => Model.UserName)" @bind-Value="Model.UserName" FullWidth="true">
            </MudTextField>
            <MudTextField T="string" Label="@L["Field.Password"]" Variant="Variant.Text" InputType="@passwordInput"
                          Adornment="Adornment.End" AdornmentIcon="@passwordInputIcon" OnAdornmentClick="SwitchPasswordVisibility"
                          Required="true" For="@(() => Model.Password)" @bind-Value="Model.Password" FullWidth="true">
            </MudTextField>
            <div class="text-center mt-3 mb-3">
                <MudButton Color="Color.Primary" Class="mt-3" Variant="Variant.Filled" OnClick="Submit"
                           StartIcon="@Icons.Filled.Login">
                    @L["Button"]
                </MudButton>
            </div>
            <MudDivider />
            <div class="text-center mt-3">
                <MudButton Color="Color.Secondary" Variant="Variant.Text" OnClick="ToRegister"
                           StartIcon="@Icons.Filled.PersonAdd">@L["Redirect"]</MudButton>
            </div>
        </MudForm>
    </MudPaper>
</div>

@code {
    MudForm? form;

    private LoginModel Model { get; set; } = new();

    private bool isShow;
    private string passwordInputIcon = Icons.Filled.VisibilityOff;
    private InputType passwordInput = InputType.Password;
    private string redirectUri = "";

    protected override void OnInitialized()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);

        var queryStrings = QueryHelpers.ParseQuery(uri.Query);

        if (queryStrings.TryGetValue("redirectUri", out var rUri))
        {
            redirectUri = rUri;
        }

        base.OnInitialized();
    }

    private void ToRegister()
    {
        NavigationManager.NavigateTo("/register");
    }

    private async void Submit()
    {
        if (ObjectHelper.IsNull(form))
        {
            return;
        }

        await form.Validate();
        if (!form.IsValid) return;
        var res = await AuthService.Login(Model);
        if (!string.IsNullOrEmpty(res))
        {
            NavigationManager.NavigateTo(string.IsNullOrEmpty(redirectUri) ? "/dashboard" : redirectUri, true);
        }
    }

    private void SwitchPasswordVisibility()
    {
        if (isShow)
        {
            isShow = false;
            passwordInputIcon = Icons.Filled.VisibilityOff;
            passwordInput = InputType.Password;
        }
        else
        {
            isShow = true;
            passwordInputIcon = Icons.Filled.Visibility;
            passwordInput = InputType.Text;
        }
    }
}