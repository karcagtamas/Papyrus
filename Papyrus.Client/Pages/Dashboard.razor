@page "/dashboard"
@attribute [Authorize]
@using Papyrus.Client.Services.Interfaces
@using Papyrus.Shared.DTOs
@using Papyrus.Shared.DTOs.Notes
@inject IUserService UserService
@inject ICommonService CommonService
@inject IStringLocalizer<Dashboard> L

<ApplicationPageTitle PageName="Dashboard" />

<div class="page-body">
    <div class="flex-box flex-row h-100 w-100">
        <div class="flex-box w-100 align-items-center justify-content-center">
            <MudText Typo="Typo.h2" Color="Color.Primary">Papyrus</MudText>
            <MudText Typo="Typo.h5" Color="Color.Primary" Class="mb-5">@L["Details"]</MudText>
            <MainImage Width="500" Class="mt-5" />
        </div>
        <div class="flex-box w-100">
            <div class="flex-box p-2">
                <MudCard Class="h-100 p-1 m-4">
                    <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-1">@L["LastAppAccess"]:</MudText>
                    <div class="p-1">
                        @foreach (var access in AppAccesses)
                        {
                            <MudText @key="access.Id">@L["AccessOn", DateHelper.DateToString(access.Timestamp)]</MudText>
                        }
                    </div>
                </MudCard>
            </div>
            <div class="flex-box p-2">
                <MudCard Class="h-100 p-1 m-4">
                    <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-1">@L["RecentNoteAccess"]:</MudText>
                    <div class="p-1">
                        @foreach (var note in RecentNotes)
                        {
                            <div @key="note.Id" class="d-flex flex-row">
                                <MudText Inline="true" style="flex: 1">@note.Title</MudText>
                                <MudButton Color="Color.Secondary" Size="Size.Small" OnClick="@(() => OpenNote(note.Id))">Open</MudButton>
                            </div>
                        }
                    </div>
                </MudCard>
            </div>
            <div class="flex-box p-2">
                <MudCard Class="h-100 p-1 m-4">
                    <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-1">@L["MostNoteAccess"]:</MudText>
                    <div class="p-1">
                        @foreach (var note in MostCommonNotes)
                        {
                            <div @key="note.Id" class="d-flex flex-row">
                                <MudText Inline="true" style="flex: 1">@note.Title</MudText>
                                <MudButton Color="Color.Secondary" Size="Size.Small" OnClick="@(() => OpenNote(note.Id))">Open</MudButton>
                            </div>
                        }
                    </div>
                </MudCard>
            </div>
        </div>
    </div>

</div>

@code
{
    public List<AccessDTO> AppAccesses { get; set; } = new();
    public List<NoteListDTO> RecentNotes { get; set; } = new();
    public List<NoteListDTO> MostCommonNotes { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        AppAccesses = await UserService.GetAppAccesses();
        RecentNotes = await UserService.GetRecentNoteAccesses();
        MostCommonNotes = await UserService.GetMostCommonNoteAccesses();

        await InvokeAsync(StateHasChanged);
    }

    private async Task OpenNote(string id)
    {
        await CommonService.OpenNote(id);
    }
}


